<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>BG TEST</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
    * { box-sizing: border-box; }
    #main {
      position: relative;
    }
    .bgc { 
      margin: 20px auto 0;
      border: 1px solid #000;
      background: url('//placehold.it/250x130');
      background-repeat: no-repeat;
      background-position: 50% 50%;
/*      background-size: cover;*/
      width: 666px;
      height: 444px;
    }
    .buttons { margin: 0px auto; width: 500px; font-size: 16px; font-family:'Open Sans',Arial,sans-serif; text-align: center; border: 1px solid #ddd; padding: 10px; }
    .buttons button { font-size: 14px; }
    .buttons span { color: #999; font-style: italic; }
  </style>
</head>
<body>

<div id="main">
  <div class="bgc"></div>

  <div class="buttons">
    Assign CSS Properties:<br />
    <button id="css_cover">Cover</button>
    <button id="css_contain">Contain</button>
  </div>
  <div class="buttons">
    JS: Calculate as percentage of container:<br />
    <button data-group="percent" id="js_original">Original</button>
    <button data-group="percent" id="js_cover">Cover</button>
    <button data-group="percent" id="js_contain">Contain</button> 
    <button data-group="percent" id="js_40vw">40vw</button>
    <button data-group="percent" id="js_66vh">66vh</button>
    <button data-group="percent" id="js_600px">600px</button>
  </div>
  <div class="buttons">
    Original Value:
      <input type="text" id="bgsize_orig"><br />
    Current Value:
      <input type="text" id="bgsize_curr">
  </div>
  <div class="buttons">
    Convert Original to Calculated: <button id="css_convert">Convert</button>
  </div>
  <div class="buttons">
    Reset CSS Properties:<br />
    <button id="css_clear">Clear Inline CSS</button> 
    <button id="css_reset">Use Original Value</button> 
    <span>(or refresh page)</span>
  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">

  // getBgImgDims() - Get the dimensions of the element's background-image 
  // @param jquery element the jquery element whose background we're seeking
  // @return object an obj in the form {w: width, h: height} in pixels.
  function getBgImgDims(element) {
    var image_url = element.css('background-image').match(/^url\("?(.+?)"?\)$/) , image_dims = {w: 0, h: 0};
    if (image_url[1]) {
      image_url = image_url[1];
      var image = new Image();
      $(image).load(function(){
        image_dims.w = image.width;
        image_dims.h = image.height;
      });
      image.src = image_url;
    }
    return image_dims;
  }

  // $.fn.css - Override the default .css method with one that triggers an event when it's called.
  (function() {
    var orig = $.fn.css;                // backup the built-in jQuery .css() method
    $.fn.css = function() {       // override the build-in .css() method
      $(this).trigger({           // trigger custom event on the target element
        type:"css_change", args:arguments   // pass the .css method's args to the handler
      }); 
      return orig.apply(this, arguments);   // perform the built-in .css() method like normal.
    }
  })();

  // Hold the original value for background-size of the container.
  var bo = "";

  // Define our background container, its dimensions, and the background-image dimensions.
  var $c = $(".bgc"),
      c = {w: $c.width(), h: $c.height() },
      m = getBgImgDims($c);

  $(function(){

    // Set up handler for changing the container's css.
    $c.on('css_change',function(e){ 
      var value = "", propCamel = "backgroundSize", propDash = "background-size"; // @TODO: propVars made dynamic or global
      // for (var i=0; i<e.args.length; i++) { console.log(typeof e.args[i], e.args[i]); } /* DEBUG: Print out arguments. */
      if ("object"== typeof e.args[0]) { // argument uses object notation: .css({'property':'value'})
        var props = Object.keys(e.args[0]); // @TODO: Loop through the args until we find the one we care about.
        if (props.length == 1 && ( props[props.length-1] == propDash || props[props.length-1] == propCamel )) {
          value = e.args[0][props[props.length-1]];
        }
      } else if ("string"== typeof e.args[0]) { // argument uses string notation: .css("property") or .css("property", "value")
        if ("undefined"!= typeof e.args[0]) { value = e.args[1]; } else { return /* goggles */; } 
      }
      if (value != "") { $("#bgsize_curr").val(value); } else { $("#bgsize_curr").val("(empty)"); } // Report the new value.
    });

    // Save the initial value for the background-size, and display its result:
    bo = $c.css('background-size');
    if (bo == "") bo = "(not set)";
    $("#bgsize_orig").val(bo);

    // Set up handlers for buttons.
    $("#css_cover").click(function(){   applyBgSizeCSS("cover",  $c); });
    $("#css_contain").click(function(){ applyBgSizeCSS("contain",$c); });
    $("#js_cover").click(function(){   calculateBgSize("cover",  $c); });
    $("#js_contain").click(function(){ calculateBgSize("contain",$c); });
    $("#js_40vw").click(function(){    calculateBgSize("40vw",   $c); });
    $("#js_66vh").click(function(){    calculateBgSize("66vh",   $c); });
    $("#js_600px").click(function(){   calculateBgSize("600px",  $c); });
    $("#js_original, #css_convert").click(function(){ calculateBgSize( bo ,    $c); });
    $("#css_clear").click(function(){   applyBgSizeCSS("",       $c); });
    $("#css_reset").click(function(){    applyBgSizeCSS( bo ,    $c); });

  });

  // applyBgSizeCSS() - Apply background-size CSS value to jQuery element
  // @param string value the value for the background-size CSS property
  // @param jquery element a jquery object representing the element which we're applying the CSS to.
  // @return jquery a jquery object representing the element, after the CSS has been applied.
  function applyBgSizeCSS(value, element, isCalculated) {
    if ("undefined"==typeof element) element = $(".bgc");
    if (value == "" || value == "(empty)" || value == "(not set)") {
      console.log("resetting CSS to initial state...");
    } else {
      if ("undefined"!=typeof isCalculated && isCalculated == true) {
        console.log("applying CSS from a calculated value (" + value + ")...");
      } else {
        console.log("applying CSS from a static CSS value (" + value + ")...");
      }
    }
    return element.css({'background-size':value});
  }

  // calculateBgSize() - Calculate the background-size CSS value for a jQuery element
  // @param string value the value for the background-size CSS property
  // @param jquery element a jquery object representing the element which we're modifying
  // @return jquery a jquery object representing the element, after it has been modified.
  function calculateBgSize(value, element) {
    var calc = 0; if ("undefined"==typeof element) element = $(".bgc");

    /* DO SOME MATH! */
    // When the image is stretched to fill 100% container width ...
    wr = c.w / m.w; // c is wr times wider than m (wr = width ratio)
    xh = m.h * wr;  // the height of m when the wr is applied (xh = calculated height)
    dh = c.h - xh;  // positive = contain, negative or 0 = cover
    // When the image is stretched to fill 100% container height ...
    hr = c.h / m.h; // c is hr times taller than m (hr = height ratio)[
    xw = m.w * hr;  // the width of m when the hr is applied (xw = calculated width)
    dw = c.w - xw;  // positive = contain, negative or 0 = cover;

    console.log(dh, dw, value);

    // Handle various background-size keywords and values
    switch(value) {
      case "contain":
        if (dh > 0 && calc == 0) {
          // container height is bigger when image is full width, satisfying 'contain'
          calc = "100%"; // bgsize:100% will stretch image to full width of the container, leaving whitespace around height.
        }
        if (dw > 0 && calc == 0) {
          // container width is bigger when image is full height, satisfying 'contain'
          // determine the width percentage that forces image height to match its container
          calc = ((xw / c.w) * 100) + "%"; // bgsize:(calc)% will stretch image to full height of container, leaving whitespace around width.
        }
        break;
      case "cover":
        if (dh <= 0 && calc == 0) {
          // image height is larger when image is full width, satisfying 'cover'
          calc = "100%"; // background-size:100% will stretch image to full width with excessive height.
        }
        if (dw <= 0 && calc == 0) {
          // image width is larger when image is full height, satisfying 'cover'
          // determine the width percentage that forces image height to match its container
          calc = ((xw / c.w) * 100) + "%"; // bgsize:(calc)% will stretch image to full height with excessive width.
        }
        break;
      case "auto": case "auto auto":
        // The default size. No stretching included.
        calc = ((m.w / c.w) * 100) + "%";
        break;
      default:
        if (value.indexOf('=')>=1 || value.indexOf(' ')>=1) {
          // 2COMPLEX4U, skip for now...
        } else if (value.indexOf('-')>=0) {
          // We don't care about negative values right now, only positive ones...
        } else {
          // This is a single positive value with units [vw,vh,px]
          if (value.indexOf('vw') >= 1) { // 10vw = 10% of $w.w
            // Image width scales with the window width.
            // CAVEAT: Converting this to a percentage of the container means that it must be recalculated on every horizontal resize.
            // @TODO: Add option to allow a resize handler to be set.
            calc = $(window).width() * (parseFloat(value) / 100); // new pixel width of image
            calc = ((calc / c.w) * 100) + "%"; // as a percentage of its container.
            break;
          } else if (value.indexOf('vh') >= 1) { // 10vh = 10% of $w.h
            // Image width scales with the window height.
            // CAVEAT: Converting this to a percentage of the container means that it must be recalculated on every vertical resize.
            // @TODO: Add option to allow a resize handler to be set.
            calc = $(window).height() * (parseFloat(value) / 100); // new pixel width of image
            calc = ((calc / c.w) * 100) + "%"; // as a percentage of its container.
            break;
          } else if (value.indexOf('px') >= 1) { 
            calc = ((parseFloat(value) / c.w) * 100) + "%"; // as a percentage of its container.
            break;
          }

        }
        

        // For now just push it through...
        console.log("Instead of cover or contain, we got passed: ", value);
        calc = value;
        break;
    }

    return applyBgSizeCSS(calc, element, 1);
  }
</script>
</body>
</html>